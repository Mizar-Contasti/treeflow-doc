---
sidebar_position: 1
---

# üß™ Fertilizantes

Los **Fertilizantes** en TreeFlow son webhooks especializados que se ejecutan cuando tu √°rbol conversacional procesa mensajes, permitiendo integrar sistemas externos y enriquecer las conversaciones con datos y funcionalidades adicionales.

## ¬øQu√© son los Fertilizantes?

Los Fertilizantes son el mecanismo de TreeFlow para conectar tu chatbot con el mundo exterior. Funcionan como "nutrientes" que enriquecen las conversaciones con:

- **Datos externos**: Informaci√≥n de CRM, bases de datos, APIs
- **Validaciones**: Verificaci√≥n de datos en tiempo real
- **Acciones**: Env√≠o de notificaciones, creaci√≥n de tickets, etc.
- **Integraciones**: Conexi√≥n con servicios empresariales

### Diferencia con Injertos

Es importante entender la diferencia:

| Concepto | Prop√≥sito | Ejemplo |
|----------|-----------|---------|
| **Injertos** | Canales de comunicaci√≥n | Widget Web, WhatsApp, Telegram |
| **Fertilizantes** | Integraciones con APIs | CRM, validadores, notificaciones |

**Analog√≠a**: Los Injertos son las "bocas y o√≠dos" del bot (c√≥mo habla con usuarios), los Fertilizantes son el "cerebro externo" (c√≥mo obtiene informaci√≥n y ejecuta acciones).

## Tipos de Fertilizantes

TreeFlow ofrece dos tipos de Fertilizantes con prop√≥sitos diferentes:

### üåü Fertilizante Principal

El **Fertilizante Principal** es el webhook global que procesa **todas** las interacciones del workspace.

#### Caracter√≠sticas:
- **√önico por workspace**: Solo uno puede estar activo
- **Procesamiento global**: Se ejecuta en cada respuesta del bot
- **Toggle de activaci√≥n**: Habilitar/deshabilitar f√°cilmente
- **Autenticaci√≥n Basic Auth**: Soporte para usuario/contrase√±a
- **Timeout configurable**: Control del tiempo l√≠mite (default: 30000ms)

#### Cu√°ndo usar:
- Logging centralizado de todas las conversaciones
- Analytics global del workspace
- Integraci√≥n con CRM para todas las interacciones
- Procesamiento uniforme de respuestas

#### Fases de Ejecuci√≥n:

El Fertilizante Principal se ejecuta en **2 fases** durante el procesamiento de un mensaje:

**Fase 1 - Pre-procesamiento**:
- Se ejecuta **antes** de que el bot genere la respuesta
- Recibe el mensaje del usuario y contexto
- Puede modificar o enriquecer el contexto
- √ötil para validaciones previas

**Fase 2 - Post-procesamiento**:
- Se ejecuta **despu√©s** de que el bot genera la respuesta
- Recibe la respuesta completa del bot
- Puede modificar la respuesta antes de enviarla al usuario
- √ötil para logging y analytics

#### Estructura del Request:

```json
{
  "phase": "pre" | "post",
  "message": {
    "type": "text",
    "value": "Mensaje del usuario",
    "session_id": "abc-123"
  },
  "tree_id": "tree-uuid",
  "workspace_id": "workspace-uuid",
  "context": {
    "active_contexts": ["contexto1"],
    "parameters": {"param1": "valor1"}
  },
  "response": {
    // Solo en fase "post"
    "text": "Respuesta del bot",
    "branch_id": "branch-uuid",
    "confidence": 0.95
  }
}
```

#### Estructura del Response Esperado:

```json
{
  "success": true,
  "modified_response": "Respuesta modificada (opcional)",
  "additional_context": {
    "key": "value"
  },
  "metadata": {
    "processed_at": "2025-10-18T22:00:00Z"
  }
}
```

### üîß Fertilizantes Adicionales

Los **Fertilizantes Adicionales** son webhooks especializados para integraciones espec√≠ficas que se ejecutan **bajo demanda** desde las Ramas.

#### Caracter√≠sticas:
- **M√∫ltiples endpoints**: Crea tantos como necesites
- **M√©todos HTTP flexibles**: GET, POST, PUT, PATCH, DELETE
- **Configuraci√≥n individual**: Cada uno con su propia config
- **Testing independiente**: Prueba cada uno por separado
- **Headers personalizados**: Agrega headers HTTP espec√≠ficos
- **Body templates**: Usa variables din√°micas en el body

#### Cu√°ndo usar:
- Validaci√≥n de datos espec√≠ficos (email, tel√©fono, etc.)
- Consulta de informaci√≥n externa (stock, precios, disponibilidad)
- Acciones espec√≠ficas (crear ticket, enviar email, etc.)
- Integraciones con APIs de terceros

#### Ejecuci√≥n desde Ramas:

Los Fertilizantes Adicionales se ejecutan cuando una Rama los invoca expl√≠citamente:

```json
{
  "branch": {
    "name": "consultar_stock",
    "webhook": {
      "fertilizer_id": "fertilizer-uuid",
      "execute_on": "match",
      "parameters": {
        "product_id": "{producto}",
        "quantity": "{cantidad}"
      }
    }
  }
}
```

#### Estructura del Request:

```json
{
  "fertilizer_id": "fertilizer-uuid",
  "branch_id": "branch-uuid",
  "parameters": {
    "producto": "laptop-123",
    "cantidad": "2"
  },
  "user_message": "Quiero 2 laptops",
  "session_id": "abc-123"
}
```

#### Estructura del Response Esperado:

```json
{
  "success": true,
  "data": {
    "stock_available": true,
    "quantity": 15,
    "price": 999.99
  },
  "message": "Hay 15 unidades disponibles"
}
```

## Configuraci√≥n

### Acceder a la Configuraci√≥n

1. En tu workspace, ve a **"Fertilizantes"** en el men√∫ lateral
2. Ver√°s dos secciones principales:
   - **Fertilizante Principal** (√∫nico por workspace)
   - **Fertilizantes Secundarios** (m√∫ltiples permitidos)

### Fertilizante Principal

**Configuraci√≥n:**
- **URL**: Endpoint de tu webhook
- **Usuario/Contrase√±a**: Autenticaci√≥n Basic Auth (opcional)
- **Timeout**: Tiempo l√≠mite en milisegundos
- **Toggle**: Activar/desactivar el fertilizante

**Pasos:**
1. Activa el toggle para habilitar
2. Completa la URL del webhook
3. Configura autenticaci√≥n si es necesaria
4. Establece el timeout (por defecto 30000ms)
5. Guarda la configuraci√≥n

### Fertilizantes Adicionales

**Configuraci√≥n:**
- **Nombre**: Identificador del fertilizante
- **Descripci√≥n**: Prop√≥sito del webhook
- **URL**: Endpoint del webhook
- **M√©todo HTTP**: GET, POST, PUT, PATCH, DELETE
- **Headers**: Headers HTTP personalizados (opcional)
- **Body Template**: Template del body con variables (opcional)
- **Timeout**: Tiempo l√≠mite en milisegundos

**Pasos:**
1. Haz clic en "Crear Fertilizante"
2. Completa nombre y descripci√≥n
3. Configura URL y m√©todo HTTP
4. Agrega headers si es necesario
5. Define body template con variables
6. Establece el timeout
7. Guarda la configuraci√≥n
8. Usa el bot√≥n "Test" para probar individualmente

## Herramientas de Testing y Debugging

TreeFlow incluye herramientas avanzadas para facilitar el desarrollo y debugging de Fertilizantes:

### üß™ Testing en Vivo

Cada Fertilizante Adicional tiene un bot√≥n "Test" que permite:

- **Simulaci√≥n de datos**: Prueba con datos de ejemplo
- **Vista previa del request**: Ve exactamente qu√© se enviar√°
- **Respuesta en tiempo real**: Observa la respuesta del webhook
- **Validaci√≥n de estructura**: Verifica que el formato sea correcto
- **C√≥digos de estado HTTP**: Identifica errores r√°pidamente

### üìä Logs Detallados

El sistema registra autom√°ticamente:

- **Timestamp preciso**: Cu√°ndo se ejecut√≥ el webhook
- **Request completo**: Headers, body, m√©todo
- **Response completo**: Status code, headers, body
- **Tiempo de respuesta**: Duraci√≥n de la ejecuci√≥n
- **Errores capturados**: Stack traces y mensajes de error

### üîÑ Retry Logic

Sistema de reintentos autom√°ticos:

- **Backoff exponencial**: Espera progresivamente mayor entre reintentos
- **M√°ximo configurable**: Define cu√°ntos reintentos permitir
- **Circuit breaker**: Protecci√≥n contra servicios ca√≠dos
- **Notificaciones**: Alertas cuando fallan persistentemente

## Casos de Uso Comunes

### üìà CRM Integration

**Fertilizante Principal** para enviar todos los leads:

```json
{
  "name": "CRM Sync",
  "url": "https://api.crm.com/leads",
  "method": "POST",
  "headers": {
    "Authorization": "Bearer YOUR_TOKEN",
    "Content-Type": "application/json"
  },
  "body_template": {
    "lead": {
      "name": "{nombre}",
      "email": "{email}",
      "phone": "{telefono}",
      "source": "chatbot",
      "conversation_id": "{session_id}"
    }
  }
}
```

### ‚úÖ Validaci√≥n de Email

**Fertilizante Adicional** para validar emails:

```json
{
  "name": "Email Validator",
  "url": "https://api.emailvalidator.com/validate",
  "method": "GET",
  "parameters": {
    "email": "{email}"
  }
}
```

### üì¶ Consulta de Stock

**Fertilizante Adicional** para verificar disponibilidad:

```json
{
  "name": "Stock Checker",
  "url": "https://api.inventory.com/stock/{product_id}",
  "method": "GET",
  "headers": {
    "X-API-Key": "YOUR_API_KEY"
  }
}
```

### üìß Notificaciones por Email

**Fertilizante Adicional** para enviar emails:

```json
{
  "name": "Email Notifier",
  "url": "https://api.sendgrid.com/v3/mail/send",
  "method": "POST",
  "headers": {
    "Authorization": "Bearer YOUR_SENDGRID_KEY",
    "Content-Type": "application/json"
  },
  "body_template": {
    "personalizations": [{
      "to": [{"email": "{email_destino}"}],
      "subject": "Nueva consulta desde chatbot"
    }],
    "from": {"email": "bot@tuempresa.com"},
    "content": [{
      "type": "text/plain",
      "value": "{mensaje}"
    }]
  }
}
```

## Mejores Pr√°cticas

### ‚úÖ Seguridad

- **Usa HTTPS**: Siempre endpoints seguros
- **Autenticaci√≥n**: Implementa API keys o tokens
- **Validaci√≥n**: Verifica datos antes de enviar
- **Rate limiting**: Protege tus APIs de sobrecarga

### ‚úÖ Performance

- **Timeouts razonables**: No m√°s de 30 segundos
- **Respuestas ligeras**: Solo datos necesarios
- **Cach√© cuando sea posible**: Reduce llamadas repetidas
- **Async cuando sea apropiado**: No bloquees la conversaci√≥n

### ‚úÖ Mantenibilidad

- **Nombres descriptivos**: Identifica f√°cilmente cada fertilizante
- **Documentaci√≥n**: Describe el prop√≥sito de cada uno
- **Versionado**: Mant√©n versiones de tus APIs
- **Monitoreo**: Revisa logs regularmente

### ‚úÖ Testing

- **Prueba en desarrollo**: Usa el bot√≥n Test antes de producci√≥n
- **Datos de ejemplo**: Ten casos de prueba preparados
- **Manejo de errores**: Verifica qu√© pasa cuando falla
- **Validaci√≥n de respuestas**: Asegura que el formato sea correcto

## Troubleshooting

### Problema: Timeout constante

**Causas posibles:**
- API externa muy lenta
- Timeout configurado muy bajo
- Problemas de red

**Soluciones:**
- Aumenta el timeout
- Optimiza la API externa
- Implementa cach√©
- Considera hacer la llamada async

### Problema: Errores 401/403

**Causas posibles:**
- Credenciales incorrectas
- Token expirado
- Permisos insuficientes

**Soluciones:**
- Verifica usuario/contrase√±a
- Renueva el token
- Revisa permisos en la API externa

### Problema: Response inv√°lido

**Causas posibles:**
- Formato JSON incorrecto
- Campos faltantes
- Tipos de datos incorrectos

**Soluciones:**
- Valida el JSON con un linter
- Revisa la documentaci√≥n de la API
- Usa el testing en vivo para depurar

## Comparaci√≥n: Principal vs Adicionales

| Caracter√≠stica | Fertilizante Principal | Fertilizantes Adicionales |
|----------------|------------------------|---------------------------|
| **Cantidad** | √önico por workspace | M√∫ltiples permitidos |
| **Ejecuci√≥n** | Autom√°tica (todas las interacciones) | Bajo demanda (desde Ramas) |
| **Fases** | Pre y Post procesamiento | Una sola ejecuci√≥n |
| **Uso principal** | Logging, analytics global | Integraciones espec√≠ficas |
| **Configuraci√≥n** | Toggle on/off | Individual por fertilizante |
| **Testing** | En producci√≥n | Bot√≥n Test individual |

## Pr√≥ximos Pasos

Una vez que domines los Fertilizantes, puedes:

1. **Explorar Injertos**: Aprende a conectar diferentes canales
2. **Configurar Ramas**: Invoca Fertilizantes desde tus intenciones
3. **Implementar Analytics**: Usa el Fertilizante Principal para tracking
4. **Integrar CRM**: Conecta con Salesforce, HubSpot, etc.









